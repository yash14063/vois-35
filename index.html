<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VisionCare - Medical Command Center</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <style>
        /* --- ORIGINAL PURPLE THEME --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { 
            --primary: #6366f1; --primary-dark: #4f46e5; 
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; 
            --dark: #1e293b; --light: #f8fafc; --border: #e2e8f0; 
            --text: #334155; --text-light: #64748b; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; color: var(--text); }
        
        /* AUTH SCREEN */
        .auth-container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; max-width: 900px; width: 100%; display: grid; grid-template-columns: 1fr 1fr; z-index: 2000; position: fixed; inset: 0; margin: auto; height: 600px; }
        .auth-left { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding: 60px 40px; color: white; display: flex; flex-direction: column; justify-content: center; }
        .auth-right { padding: 60px 40px; background: white; display: flex; flex-direction: column; justify-content: center; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn:hover { background: var(--primary-dark); }

        /* DASHBOARD */
        .dashboard { display: none; background: #f1f5f9; width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; flex-direction: column; }
        .dashboard.active { display: flex; }
        
        /* NAVBAR */
        .navbar { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
        .navbar-brand { font-size: 1.5rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .nav-tabs { display: flex; gap: 10px; background: #f1f5f9; padding: 5px; border-radius: 10px; }
        .nav-tab { padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-light); transition: 0.3s; }
        .nav-tab:hover { background: white; }
        .nav-tab.active { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* CONTENT AREA */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; }
        .view-section { display: none; gap: 20px; height: 100%; }
        .view-section.active { display: grid; }

        /* LAYOUTS */
        #view-monitor { grid-template-columns: 280px 1fr 300px; }
        #view-analytics { grid-template-columns: 1fr 1fr; }
        #view-history { display: block; }

        /* PANELS */
        .panel { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; margin-bottom: 20px; }
        .panel-title { font-size: 1rem; font-weight: 700; color: var(--dark); margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; display: flex; justify-content: space-between; }

        /* WIDGETS */
        .status-card { background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
        .status-label { font-size: 0.8rem; color: var(--text-light); font-weight: 600; text-transform: uppercase; }
        .status-val { font-size: 1.2rem; font-weight: 700; color: var(--dark); }

        /* CAMERA BOX */
        .camera-box { 
            background: black; border-radius: 12px; position: relative; overflow: hidden; 
            flex: 1; display: flex; align-items: center; justify-content: center; min-height: 400px;
            border: 4px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        video { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 10; }
        
        .start-btn {
            position: absolute; z-index: 50; background: var(--primary); color: white;
            border: none; padding: 15px 30px; border-radius: 50px; font-weight: bold; cursor: pointer;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.5); font-size: 1rem;
        }

        .voice-toggle {
            position: absolute; top: 15px; right: 15px; z-index: 20;
            background: white; color: var(--primary); border: none;
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: 700; font-size: 0.85rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .message-box { padding: 20px; border-radius: 12px; text-align: center; font-size: 1.5rem; font-weight: 700; background: #e0e7ff; color: var(--primary); margin-top: 20px; transition: 0.3s; }
        .message-emergency { background: #fee2e2; color: #ef4444; animation: pulseRed 1s infinite; }
        @keyframes pulseRed { 0% { transform: scale(1); } 50% { transform: scale(1.02); } }

        /* GESTURE GRID */
        .gesture-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 300px; overflow-y: auto; }
        .g-card { background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center; border: 2px solid transparent; }
        .g-card.active { border-color: var(--primary); background: #e0e7ff; }
        .g-icon { font-size: 1.5rem; display: block; }

        /* BODY TWIN */
        .body-wrapper { display: flex; justify-content: center; align-items: center; height: 350px; background: #f8fafc; border-radius: 20px; position: relative; }
        .body-outline { width: 120px; height: 300px; border: 3px solid #cbd5e1; border-radius: 40px; position: relative; background: white; }
        .organ { position: absolute; background: #e2e8f0; border: 1px solid #94a3b8; transition: 0.3s; }
        .head { top: 10px; left: 30px; width: 60px; height: 60px; border-radius: 50%; }
        .chest { top: 80px; left: 20px; width: 80px; height: 80px; border-radius: 20px; }
        .stomach { top: 170px; left: 30px; width: 60px; height: 60px; border-radius: 15px; }
        .pain-active { background: #ef4444; border-color: #991b1b; box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }

        /* HISTORY */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #f1f5f9; color: var(--text-light); }
        td { padding: 15px; border-bottom: 1px solid #e2e8f0; }

        /* SOS */
        #sos-overlay { position: fixed; inset: 0; background: rgba(220, 38, 38, 0.95); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }

        /* --- NEW ANIMATION FOR VOICE FEEDBACK --- */
        @keyframes fadeUp { 0% {opacity:0; transform:translateY(20px);} 10% {opacity:1; transform:translateY(0);} 90% {opacity:1;} 100% {opacity:0; display:none;} }

        @media (max-width: 1200px) { .view-section, .auth-container { grid-template-columns: 1fr !important; } .auth-left { display: none; } }
    </style>
</head>
<body>

    <div class="auth-container" id="authPage">
        <div class="auth-left">
            <h1>üéØ VisionCare</h1>
            <p style="margin-top:10px; opacity:0.9;">AI-Powered Patient Monitoring System</p>
        </div>
        <div class="auth-right">
            <h2 style="margin-bottom:20px; color:var(--dark)">Medical Login</h2>
            <div class="form-group">
                <label>Doctor ID</label>
                <input type="text" value="DR-CHEN-9921" readonly>
            </div>
            <div class="form-group">
                <label>Access Key</label>
                <input type="password" value="********" readonly>
            </div>
            <button class="btn" onclick="handleLogin()">Access Dashboard</button>
        </div>
    </div>

    <div class="dashboard" id="dashboardPage">
        
        <div class="navbar">
            <button onclick="testNotification()" style="padding:5px 10px; font-size:0.8rem; background:#ef4444; color:white; border:none; border-radius:5px; cursor:pointer;">
            üîî Test Alert
                </button>
            <div class="navbar-brand"><i class="fas fa-eye"></i> VisionCare Pro</div>
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('monitor', this)">üì° Monitor</div>
                <div class="nav-tab" onclick="switchTab('analytics', this)">üìä Analytics</div>
                <div class="nav-tab" onclick="switchTab('history', this)">üìã History</div>
            </div>
            <div><span style="font-weight:600">Dr. Emily Chen</span></div>
        </div>

        <div class="main-content">

            <div id="view-monitor" class="view-section active">
                <div class="panel">
                    <div class="panel-title">Real-Time Vitals</div>
                    <div class="status-card"><div class="status-label">Heart Rate</div><div class="status-val" style="color:#ef4444">72 BPM</div></div>
                    <div class="status-card"><div class="status-label">SpO2</div><div class="status-val" style="color:#3b82f6">98%</div></div>
                    <div class="status-card"><div class="status-label">Active Gesture</div><div class="status-val" id="live-gesture">--</div></div>
                </div>

                <div class="panel">
                    <div class="panel-title"><span>Live Feed</span></div>
                    <div class="camera-box">
                        <button id="startCamBtn" class="start-btn" onclick="startCamera()">TAP TO START CAMERA</button>
                        <video id="input_video" playsinline muted></video>
                        <canvas id="output_canvas"></canvas>
                        <button class="voice-toggle" id="voiceBtn" onclick="toggleVoice()">üîä ON</button>
                    </div>
                    <div class="message-box" id="messageBox">System Ready</div>
                </div>

                <div class="panel">
                    <div class="panel-title">Gesture Guide</div>
                    <div class="gesture-grid" id="gesture-grid"></div>
                    <div style="margin-top:20px; flex:1; overflow-y:auto;">
                        <div class="panel-title">Quick Log</div>
                        <div id="quick-log" style="font-size:0.85rem; color:var(--text-light);"></div>
                    </div>
                </div>
            </div>

            <div id="view-analytics" class="view-section">
                <div class="panel">
                    <div class="panel-title">ü©ª Body Analytics</div>
                    <div style="display:flex; gap:20px;">
                        <div class="body-wrapper" style="flex:1">
                            <div class="body-outline">
                                <div id="organ-head" class="organ head"></div>
                                <div id="organ-chest" class="organ chest"></div>
                                <div id="organ-stomach" class="organ stomach"></div>
                            </div>
                        </div>
                        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                            <div class="status-card"><div class="status-label">Pain Location</div><div class="status-val" id="pain-loc">None</div></div>
                            <div class="status-card"><div class="status-label">Status</div><div class="status-val" id="sys-diag" style="color:#10b981">Stable</div></div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-title">üìà Intake Tracker</div>
                    <div style="height:250px; position:relative;"><canvas id="intakeChart"></canvas></div>
                    <div style="display:flex; justify-content:space-around; margin-top:20px;">
                        <div><div style="font-size:1.5rem; font-weight:bold; color:#3b82f6" id="val-water">0</div><div style="font-size:0.8rem">Water (ml)</div></div>
                        <div><div style="font-size:1.5rem; font-weight:bold; color:#f59e0b" id="val-food">0</div><div style="font-size:0.8rem">Meals</div></div>
                        <div><div style="font-size:1.5rem; font-weight:bold; color:#10b981" id="val-meds">0</div><div style="font-size:0.8rem">Meds</div></div>
                    </div>
                </div>
            </div>

            <div id="view-history" class="view-section">
                <div class="panel">
                    <div class="panel-title">üè• Patient Profile</div>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:20px; margin-bottom:20px;">
                        <div><div style="color:var(--text-light); font-size:0.9rem;">Name</div><div style="font-weight:bold;">Alex Smith</div></div>
                        <div><div style="color:var(--text-light); font-size:0.9rem;">Condition</div><div style="font-weight:bold;">Post-Op</div></div>
                        <div><div style="color:var(--text-light); font-size:0.9rem;">Blood</div><div style="font-weight:bold;">O+</div></div>
                    </div>
                    <div class="panel-title">üìã Event History</div>
                    <table>
                        <thead><tr><th>Time</th><th>Category</th><th>Details</th></tr></thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div id="sos-overlay">
        <h1 style="font-size:5rem;">üö® SOS üö®</h1>
        <p>Patient Distress Signal</p>
        <button onclick="dismissSOS()" style="padding:15px 40px; background:white; color:red; border:none; font-size:1.2rem; font-weight:bold; cursor:pointer; border-radius:10px;">ACKNOWLEDGE</button>
    </div>

<script>
    // --- SETUP ---
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    // UI
    const liveGesture = document.getElementById('live-gesture');
    const msgBox = document.getElementById('messageBox');
    const quickLog = document.getElementById('quick-log');
    const startBtn = document.getElementById('startCamBtn');
    
    // Body & Analytics
    const organHead = document.getElementById('organ-head');
    const organChest = document.getElementById('organ-chest');
    const organStomach = document.getElementById('organ-stomach');
    const painLoc = document.getElementById('pain-loc');
    const sysDiag = document.getElementById('sys-diag');

    let voiceMuted = false;
    let lastSpoken = "";
    let isSosActive = false;
    let chartInstance;
    let intake = { water: 0, food: 0, meds: 0 };

    // --- GESTURE DICTIONARY ---
    const gestures = [
        { name: "Fist", msg: "Stop / Wait", icon: "‚úä" },
        { name: "Open Palm", msg: "Hello / Nurse", icon: "‚úã" },
        { name: "Victory", msg: "Water", icon: "‚úåÔ∏è" },
        { name: "Point", msg: "Medicine", icon: "‚òùÔ∏è" },
        { name: "Thumb Up", msg: "Yes", icon: "üëç" },
        { name: "Thumb Down", msg: "No", icon: "üëé" },
        { name: "Pinky", msg: "Washroom", icon: "ü§ô" },
        { name: "Gun", msg: "Chest Pain", icon: "üíî" },
        { name: "OK Sign", msg: "I am Okay", icon: "üëå" },
        { name: "Three", msg: "Hungry", icon: "ü•ò" },
        { name: "Four", msg: "Headache", icon: "ü§ï" }
    ];
    
    function testNotification() {
    // 1. Check if browser supports it
    if (!("Notification" in window)) {
        alert("This browser does not support desktop notifications");
        return;
    }

    // 2. Request permission manually
    Notification.requestPermission().then(permission => {
        if (permission === "granted") {
            const notif = new Notification("Test Alert", {
                body: "System notifications are working!",
                icon: "https://cdn-icons-png.flaticon.com/512/822/822118.png"
            });
            // Play a sound for effect
            speak("Test notification sent");
        } else {
            alert("Permission denied. Please click the Lock icon in URL bar and 'Allow' Notifications.");
        }
    });
}
    // --- LOGIC ---
    function handleLogin() {
        document.getElementById('authPage').style.display = 'none';
        document.getElementById('dashboardPage').classList.add('active');
        initCharts();
        renderGrid();
        
        // --- ADDED: START VOICE CONTROL ON LOGIN ---
        initVoiceControl();
        speak("System Online. Sterile Voice Command Interface Activated.");
        
        if ("Notification" in window) {
            Notification.requestPermission();
        }
    }

    function switchTab(viewId, tab) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active');
        tab.classList.add('active');
    }

    function toggleVoice() {
        voiceMuted = !voiceMuted;
        document.getElementById('voiceBtn').innerText = voiceMuted ? "üîá OFF" : "üîä ON";
    }

    // --- PROCESS GESTURE ---
    function processGesture(name, msg) {
        liveGesture.innerText = name;
        msgBox.innerText = msg;
        
        // Highlight
        document.querySelectorAll('.g-card').forEach(c => c.classList.remove('active'));
        const activeCard = Array.from(document.querySelectorAll('.g-card')).find(c => c.innerText.includes(name));
        if(activeCard) activeCard.classList.add('active');

        // Styles
        if(msg.includes("Pain")) msgBox.className = "message-box message-emergency";
        else msgBox.className = "message-box";

        // Action
        if(msg !== lastSpoken && msg !== "Scanning..." && !isSosActive) {
            lastSpoken = msg;
            if(!voiceMuted) speak(msg);
            
            // Log
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            quickLog.innerHTML = `<div><b>${time}:</b> ${msg}</div>` + quickLog.innerHTML;
            
            const row = document.createElement('tr');
            row.innerHTML = `<td>${time}</td><td>${name}</td><td>${msg}</td>`;
            document.getElementById('history-table-body').prepend(row);

            // Updates
            updateIntake(msg);
            updateBody(msg);
            
            sendDoctorNotification(name, msg);
        }
    }

    function sendDoctorNotification(title, message) {
        if (!("Notification" in window)) return;
        
        if (Notification.permission === "granted") {
            const options = {
                body: `Patient Action: ${message}`,
                icon: 'https://cdn-icons-png.flaticon.com/512/822/822118.png',
                silent: false
            };
            
            if (message.includes("Pain") || message.includes("Nurse") || message.includes("Washroom")) {
                 new Notification("VisionCare Alert: Alex Smith", options);
            }
        }
    }

    function updateIntake(msg) {
        if(msg.includes("Water")) intake.water++;
        if(msg.includes("Hungry")) intake.food++;
        if(msg.includes("Medicine")) intake.meds++;
        
        document.getElementById('val-water').innerText = intake.water * 250;
        document.getElementById('val-food').innerText = intake.food;
        document.getElementById('val-meds').innerText = intake.meds;
        
        if(chartInstance) {
            chartInstance.data.datasets[0].data = [intake.water*250, intake.food*100, intake.meds*10];
            chartInstance.update();
        }
    }

    function updateBody(msg) {
        organHead.classList.remove('pain-active');
        organChest.classList.remove('pain-active');
        organStomach.classList.remove('pain-active');
        painLoc.innerText = "None";
        sysDiag.innerText = "Stable"; sysDiag.style.color="#10b981";

        if(msg.includes("Headache")) {
            organHead.classList.add('pain-active');
            painLoc.innerText = "Head";
            sysDiag.innerText = "Migraine"; sysDiag.style.color="#f59e0b";
        }
        else if(msg.includes("Chest")) {
            organChest.classList.add('pain-active');
            painLoc.innerText = "Chest";
            sysDiag.innerText = "CRITICAL"; sysDiag.style.color="#ef4444";
            triggerSOS();
        }
        else if(msg.includes("Hungry")) {
            organStomach.classList.add('pain-active');
            painLoc.innerText = "Stomach";
        }
    }

    function triggerSOS() {
        isSosActive = true;
        document.getElementById('sos-overlay').style.display = 'flex';
        speak("Emergency Alert");
    }

    function dismissSOS() {
        isSosActive = false;
        document.getElementById('sos-overlay').style.display = 'none';
        window.speechSynthesis.cancel();
    }

    function speak(text) { window.speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }

    // --- CAMERA LOGIC ---
    async function startCamera() {
        startBtn.innerText = "Initializing...";
        try {
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });
            hands.onResults(onResults);
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = stream;
            videoElement.onloadedmetadata = () => {
                videoElement.play();
                startBtn.style.display = 'none';
                processVideo(hands);
            };
        } catch(e) {
            alert("Camera Error: " + e.message + "\nCheck Permissions or HTTPS.");
            startBtn.innerText = "Retry Camera";
        }
    }

    async function processVideo(hands) {
        if(videoElement.videoWidth) {
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            await hands.send({image: videoElement});
        }
        requestAnimationFrame(() => processVideo(hands));
    }

    function onResults(results) {
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            const handedness = results.multiHandedness[0].label;
            
            // --- UPDATED: TECH VISUALS (Cyberpunk Style) ---
            drawConnectors(canvasCtx, lm, HAND_CONNECTIONS, {color: '#00ffcc', lineWidth: 2}); // Cyan tech lines
            drawLandmarks(canvasCtx, lm, {color: '#ffffff', lineWidth: 1, radius: 2}); // White nodes

            // Target Lock Box
            const xList = lm.map(p => p.x);
            const yList = lm.map(p => p.y);
            const minX = Math.min(...xList) * canvasElement.width;
            const maxX = Math.max(...xList) * canvasElement.width;
            const minY = Math.min(...yList) * canvasElement.height;
            const maxY = Math.max(...yList) * canvasElement.height;

            canvasCtx.strokeStyle = "rgba(255, 0, 0, 0.5)"; // Red targeting box
            canvasCtx.lineWidth = 2;
            canvasCtx.strokeRect(minX - 20, minY - 20, (maxX - minX) + 40, (maxY - minY) + 40);

            canvasCtx.font = "16px Courier New";
            canvasCtx.fillStyle = "#00ffcc";
            canvasCtx.fillText("ANALYZING GESTURE...", minX, minY - 30);
            // ----------------------------------------------

            let fingers = [];
            if (handedness === 'Right') fingers.push(lm[4].x < lm[3].x ? 1 : 0);
            else fingers.push(lm[4].x > lm[3].x ? 1 : 0);
            [8, 12, 16, 20].forEach(t => fingers.push(lm[t].y < lm[t-2].y ? 1 : 0));

            let name = "--", msg = "Scanning...";
            
            if(Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y) < 0.05) { name="OK Sign"; msg="I am Okay"; }
            else {
                const key = fingers.join(",");
                if(key === "0,0,0,0,0") { name="Fist"; msg="Stop"; }
                if(key === "1,1,1,1,1") { name="Open Palm"; msg="Hello"; }
                if(key === "0,1,1,0,0") { name="Victory"; msg="Water"; }
                if(key === "0,1,0,0,0") { name="Point"; msg="Medicine"; }
                if(key === "1,0,0,0,0") { name="Thumb Up"; msg="Yes"; }
                if(key === "0,0,0,0,1") { name="Pinky"; msg="Washroom"; }
                if(key === "1,1,1,0,0") { name="Gun"; msg="Chest Pain"; }
                if(key === "0,1,1,1,1") { name="Four"; msg="Headache"; }
                if(key === "0,1,1,1,0") { name="Three"; msg="Hungry"; }
            }
            processGesture(name, msg);
        }
    }

    // --- RENDERERS ---
    function renderGrid() {
        const grid = document.getElementById('gesture-grid');
        gestures.forEach(g => {
            grid.innerHTML += `<div class="g-card"><span class="g-icon">${g.icon}</span><div style="font-size:0.8rem; font-weight:bold;">${g.name}</div><div style="font-size:0.7rem; color:var(--text-light)">${g.msg}</div></div>`;
        });
    }

    function initCharts() {
        const ctx = document.getElementById('intakeChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['Water', 'Food', 'Meds'], datasets: [{ label: 'Today', data: [0,0,0], backgroundColor: ['#3b82f6', '#f59e0b', '#10b981'] }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

    // --- NEW: STERILE VOICE COMMAND MODULE ---
    function initVoiceControl() {
        if (!('webkitSpeechRecognition' in window)) {
            console.log("Browser does not support Voice API");
            return;
        }

        const recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = () => {
            document.querySelector('.navbar-brand').innerHTML = '<i class="fas fa-microphone-alt" style="color:#ef4444; animation:pulse 1s infinite;"></i> Listening...';
        };

        recognition.onresult = (event) => {
            const command = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
            console.log("Doctor Command:", command);
            processDoctorCommand(command);
        };

        recognition.start();
    }

    function processDoctorCommand(cmd) {
        // VISUAL FEEDBACK
        const feedback = document.createElement('div');
        feedback.style = "position:fixed; bottom:20px; right:20px; background:var(--dark); color:white; padding:10px 20px; border-radius:30px; z-index:9999; animation: fadeUp 2s forwards;";
        feedback.innerHTML = `<i class="fas fa-user-md"></i> Cmd: "${cmd}"`;
        document.body.appendChild(feedback);

        // COMMAND LOGIC
        if (cmd.includes("monitor") || cmd.includes("home")) {
            switchTab('monitor', document.querySelectorAll('.nav-tab')[0]);
            speak("Switching to Monitor View");
        }
        else if (cmd.includes("analytics") || cmd.includes("data")) {
            switchTab('analytics', document.querySelectorAll('.nav-tab')[1]);
            speak("Showing Patient Analytics");
        }
        else if (cmd.includes("history") || cmd.includes("report")) {
            switchTab('history', document.querySelectorAll('.nav-tab')[2]);
            speak("Pulling History Records");
        }
        else if (cmd.includes("stop") || cmd.includes("silence") || cmd.includes("acknowledge")) {
            if(isSosActive) {
                dismissSOS();
                speak("Alarm Silenced. Protocol Logged.");
            }
        }
        else if (cmd.includes("status") || cmd.includes("update")) {
            const hr = "72"; 
            const ox = "98";
            speak(`Patient is stable. Heart rate ${hr}, Oxygen ${ox} percent.`);
        }
    }
</script>
</body>
</html>
