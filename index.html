<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionCare Pro | Real-Time AI Assistive Platform</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --primary: #4F46E5;
            --secondary: #ec4899;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --alert: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* --- SIDEBAR --- */
        .sidebar { width: 80px; background: var(--bg-card); display: flex; flex-direction: column; align-items: center; padding: 20px 0; border-right: 1px solid #334155; z-index: 100; transition: width 0.3s; }
        .sidebar:hover { width: 240px; align-items: flex-start; padding-left: 20px; }
        .sidebar:hover .link-text { display: inline; opacity: 1; }
        
        .brand { color: var(--primary); font-size: 1.8rem; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; font-weight: 800; }
        .nav-item { width: 100%; padding: 15px; color: var(--text-muted); cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 15px; white-space: nowrap; }
        .nav-item:hover, .nav-item.active { color: var(--text-main); background: rgba(79, 70, 229, 0.1); border-left: 4px solid var(--primary); }
        .nav-icon { font-size: 1.4rem; width: 30px; text-align: center; }
        .link-text { display: none; opacity: 0; transition: opacity 0.3s; font-size: 1rem; font-weight: 600; }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; padding: 20px; display: flex; gap: 20px; overflow-y: auto; }
        .col-left { flex: 2; display: flex; flex-direction: column; gap: 20px; }
        .col-right { flex: 1; display: flex; flex-direction: column; gap: 20px; }

        /* --- CARDS --- */
        .card { background: var(--bg-card); border-radius: 16px; padding: 20px; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        /* --- VIDEO FEED --- */
        .video-container { position: relative; width: 100%; border-radius: 16px; overflow: hidden; background: #000; aspect-ratio: 16/9; border: 2px solid var(--primary); }
        video { display: none; } /* Hide raw video, show canvas */
        canvas { width: 100%; height: 100%; transform: scaleX(-1); object-fit: cover; }
        
        .overlay-status { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; border: 1px solid var(--success); }
        .status-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 1.5s infinite; }

        /* --- OUTPUT DISPLAY --- */
        .gesture-box { text-align: center; padding: 30px; background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(236, 72, 153, 0.1)); border: 1px solid var(--primary); }
        .gesture-name { font-size: 3rem; font-weight: 800; color: var(--primary); text-shadow: 0 0 20px rgba(79, 70, 229, 0.5); margin: 10px 0; min-height: 60px; }
        .gesture-msg { font-size: 1.2rem; color: var(--text-muted); }

        /* --- VITALS & LOGS --- */
        .vitals-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .vital-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; text-align: center; }
        .vital-val { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .vital-label { font-size: 0.8rem; color: var(--text-muted); }

        .log-list { height: 300px; overflow-y: auto; padding-right: 5px; }
        .log-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #334155; font-size: 0.9rem; }
        .log-time { color: var(--text-muted); }
        .log-text { color: var(--primary); font-weight: 600; }

        /* --- ANIMATIONS --- */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* --- LOADING SCREEN --- */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid #334155; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- SOS OVERLAY --- */
        #sos-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(239, 68, 68, 0.9); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .sos-active { display: flex !important; animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { background: rgba(239, 68, 68, 0.9); } 50% { background: rgba(239, 68, 68, 0.7); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <h2>Initializing AI Vision Core...</h2>
        <p style="color: var(--text-muted)">Please allow camera access</p>
    </div>

    <div id="sos-overlay">
        <i class="fas fa-exclamation-triangle" style="font-size: 5rem; color: white; margin-bottom: 20px;"></i>
        <h1 style="font-size: 4rem; color: white;">EMERGENCY SOS</h1>
        <p style="font-size: 1.5rem; color: white;">Help Request Triggered</p>
        <button onclick="stopSOS()" style="margin-top: 30px; padding: 15px 40px; font-size: 1.2rem; border: none; border-radius: 30px; cursor: pointer;">DISMISS ALERT</button>
    </div>

    <nav class="sidebar">
        <div class="brand">
            <i class="fas fa-eye"></i>
            <span class="link-text">VisionCare</span>
        </div>
        <div class="nav-item active">
            <div class="nav-icon"><i class="fas fa-columns"></i></div>
            <span class="link-text">Dashboard</span>
        </div>
        <div class="nav-item">
            <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
            <span class="link-text">Analytics</span>
        </div>
        <div class="nav-item">
            <div class="nav-icon"><i class="fas fa-user-injured"></i></div>
            <span class="link-text">Patient Profile</span>
        </div>
        <div class="nav-item" style="margin-top: auto; color: var(--alert);">
            <div class="nav-icon"><i class="fas fa-power-off"></i></div>
            <span class="link-text">Logout</span>
        </div>
    </nav>

    <main class="main">
        
        <div class="col-left">
            <div class="card video-container">
                <div class="overlay-status">
                    <div class="status-dot"></div>
                    AI Vision Active
                </div>
                <video id="input_video"></video>
                <canvas id="output_canvas"></canvas>
            </div>

            <div class="card gesture-box">
                <div class="card-title">Real-Time Translation</div>
                <div class="gesture-name" id="gesture-output">--</div>
                <div class="gesture-msg" id="message-output">Waiting for gesture...</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Communication Frequency</span>
                    <i class="fas fa-ellipsis-h" style="color: var(--text-muted)"></i>
                </div>
                <div style="height: 200px">
                    <canvas id="usageChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-right">
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Patient Vitals (Live)</span>
                    <i class="fas fa-heartbeat" style="color: var(--secondary)"></i>
                </div>
                <div class="vitals-grid">
                    <div class="vital-item">
                        <div class="vital-val" id="bpm-val">72</div>
                        <div class="vital-label">BPM</div>
                    </div>
                    <div class="vital-item">
                        <div class="vital-val" style="color: var(--success)">98%</div>
                        <div class="vital-label">SpO2</div>
                    </div>
                    <div class="vital-item">
                        <div class="vital-val">98.6Â°</div>
                        <div class="vital-label">Temp</div>
                    </div>
                    <div class="vital-item">
                        <div class="vital-val" style="color: var(--primary)">12/min</div>
                        <div class="vital-label">Resp</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Communication Log</span>
                    <button style="background:none; border:none; color: var(--primary); cursor: pointer;" onclick="clearLogs()">Clear</button>
                </div>
                <div class="log-list" id="log-container">
                    </div>
            </div>

        </div>
    </main>

<script>
    // --- 1. CONFIGURATION & STATE ---
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const gestureOutput = document.getElementById('gesture-output');
    const messageOutput = document.getElementById('message-output');
    const logContainer = document.getElementById('log-container');
    let lastSpoken = "";
    let lastLogTime = 0;
    let sosTimer = null;
    let isSosActive = false;

    // --- 2. GESTURE DICTIONARY (22+ DEFINITIONS) ---
    // Mapping: Thumb, Index, Middle, Ring, Pinky (0 = Folded, 1 = Extended)
    const gestureMap = {
        "0,0,0,0,0": { name: "Fist", msg: "Stop / Wait", type: "stop" },
        "1,1,1,1,1": { name: "Open Palm", msg: "Hello / Nurse", type: "normal" },
        "0,1,0,0,0": { name: "Point", msg: "I need Medicine", type: "med" },
        "0,1,1,0,0": { name: "Victory", msg: "I need Water", type: "water" },
        "0,1,1,1,0": { name: "Three", msg: "I am Hungry", type: "food" },
        "0,1,1,1,1": { name: "Four", msg: "Wheelchair", type: "move" },
        "1,1,1,1,0": { name: "Four+Thumb", msg: "Pain Level 5", type: "pain" },
        "1,0,0,0,0": { name: "Thumb Up", msg: "Yes / Good", type: "yes" },
        "0,1,1,1,1": { name: "Thumb Down", msg: "No / Bad", type: "no" }, // Logic handled in code
        "0,0,0,0,1": { name: "Pinky", msg: "Washroom", type: "toilet" },
        "1,0,0,0,1": { name: "Call", msg: "Call Family", type: "phone" },
        "1,1,0,0,1": { name: "Spider-Man", msg: "I Love You", type: "love" },
        "0,1,0,0,1": { name: "Rock", msg: "Turn on TV", type: "ent" },
        "1,1,0,0,0": { name: "L-Shape", msg: "Lights On/Off", type: "light" },
        "0,0,1,1,1": { name: "OK Sign", msg: "I am Okay", type: "ok" }, // Geometric check
        "1,1,1,0,0": { name: "Gun", msg: "Chest Pain", type: "pain" },
        "0,0,1,0,0": { name: "Middle", msg: "Urgent Help", type: "urgent" },
        "1,0,1,0,0": { name: "V+Thumb", msg: "Cold", type: "temp" },
        "1,0,0,1,0": { name: "Ring+Thumb", msg: "Hot", type: "temp" },
        "1,1,0,1,1": { name: "Claw", msg: "Cramps", type: "pain" },
        "0,1,0,1,0": { name: "Split", msg: "Adjust Bed", type: "bed" },
        "0,0,0,1,1": { name: "Rabbit", msg: "Sleep", type: "sleep" }
    };

    // --- 3. HELPER FUNCTIONS ---
    function speak(text) {
        if(text !== lastSpoken && text !== "Stop / Wait" && !isSosActive) {
            let u = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(u);
            lastSpoken = text;
            addLog(text);
            updateChart();
        }
    }

    function addLog(msg) {
        if (Date.now() - lastLogTime < 2000) return;
        const div = document.createElement('div');
        div.className = 'log-item';
        div.innerHTML = `<span class="log-text">${msg}</span><span class="log-time">${new Date().toLocaleTimeString()}</span>`;
        logContainer.prepend(div);
        lastLogTime = Date.now();
    }

    function clearLogs() { logContainer.innerHTML = ''; }

    function triggerSOS() {
        if(isSosActive) return;
        isSosActive = true;
        document.getElementById('sos-overlay').classList.add('sos-active');
        // Loop scream sound or voice
        let sosLoop = setInterval(() => {
            if(!isSosActive) clearInterval(sosLoop);
            else window.speechSynthesis.speak(new SpeechSynthesisUtterance("Emergency! Emergency!"));
        }, 2000);
    }

    function stopSOS() {
        isSosActive = false;
        document.getElementById('sos-overlay').classList.remove('sos-active');
        window.speechSynthesis.cancel();
    }

    // --- 4. FINGER TRACKING LOGIC ---
    function getFingerState(lm, handedness) {
        let fingers = [];
        // Thumb (X-axis check depends on hand)
        if (handedness === 'Right') {
            fingers.push(lm[4].x < lm[3].x ? 1 : 0);
        } else {
            fingers.push(lm[4].x > lm[3].x ? 1 : 0);
        }
        // Index, Middle, Ring, Pinky (Y-axis check)
        [8, 12, 16, 20].forEach(tip => {
            fingers.push(lm[tip].y < lm[tip - 2].y ? 1 : 0);
        });
        return fingers;
    }

    function detectGesture(fingers, lm) {
        // Special Geometric Checks
        let thumbIndexDist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
        if(thumbIndexDist < 0.05) return gestureMap["0,0,1,1,1"]; // OK Sign

        // Thumbs Down Check
        if(fingers[0] === 0 && fingers[1]===0 && fingers[2]===0 && lm[4].y > lm[3].y) {
            return { name: "Thumb Down", msg: "No / Disagree", type: "no" };
        }

        let key = fingers.join(",");
        return gestureMap[key] || { name: "--", msg: "Scanning...", type: "none" };
    }

    // --- 5. MEDIAPIPE SETUP ---
    function onResults(results) {
        document.getElementById('loader').style.opacity = '0';
        setTimeout(()=> document.getElementById('loader').style.display='none', 500);

        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        
        // Draw Sci-Fi Connectors
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            const handedness = results.multiHandedness[0].label;

            drawConnectors(canvasCtx, lm, HAND_CONNECTIONS, {color: '#4F46E5', lineWidth: 4});
            drawLandmarks(canvasCtx, lm, {color: '#ec4899', lineWidth: 2, radius: 4});

            const fingers = getFingerState(lm, handedness);
            const result = detectGesture(fingers, lm);

            gestureOutput.innerText = result.name;
            messageOutput.innerText = result.msg;
            
            if(result.type !== "none") speak(result.msg);

            // SOS Trigger (Hold Fist for 3 seconds)
            if(result.name === "Fist") {
                if(!sosTimer) sosTimer = setTimeout(triggerSOS, 3000);
            } else {
                clearTimeout(sosTimer);
                sosTimer = null;
            }
        }
        canvasCtx.restore();
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 1280, height: 720
    });
    camera.start();

    // --- 6. EXTRAS (Vitals Sim & Chart) ---
    // Simulate Vitals
    setInterval(() => {
        document.getElementById('bpm-val').innerText = 70 + Math.floor(Math.random() * 5);
    }, 2000);

    // Chart.js
    const ctx = document.getElementById('usageChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['10am', '11am', '12pm', '1pm', '2pm', '3pm'],
            datasets: [{
                label: 'Requests',
                data: [2, 5, 1, 8, 3, 0],
                borderColor: '#4F46E5',
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(79, 70, 229, 0.1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { color: '#334155' } },
                x: { grid: { color: '#334155' } }
            }
        }
    });

    function updateChart() {
        // Mock update for visual effect
        let data = myChart.data.datasets[0].data;
        data[data.length - 1]++;
        myChart.update();
    }

</script>
</body>
</html>
