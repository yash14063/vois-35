<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionCare: Real-Time Sync</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <style>
        :root { --primary: #2563eb; --alert: #ef4444; --safe: #10b981; --dark: #0f172a; --bg: #f8fafc; }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- ROLE SELECTOR --- */
        .role-overlay { position: fixed; inset: 0; background: white; z-index: 5000; display: flex; align-items: center; justify-content: center; gap: 40px; }
        .role-card { width: 280px; padding: 40px; border: 2px solid #e2e8f0; border-radius: 24px; text-align: center; cursor: pointer; transition: 0.3s; }
        .role-card:hover { border-color: var(--primary); transform: translateY(-10px); box-shadow: 0 20px 40px rgba(37, 99, 235, 0.15); }
        .role-icon { font-size: 4rem; margin-bottom: 20px; color: var(--primary); }
        h2 { margin: 0 0 10px 0; color: var(--dark); }
        p { margin: 0; color: #64748b; font-size: 0.9rem; }

        /* --- LAYOUTS --- */
        .app-screen { display: none; height: 100%; flex-direction: column; }
        .app-screen.active { display: flex; }

        /* --- PATIENT UI --- */
        .patient-grid { display: grid; grid-template-columns: 2fr 1fr; height: 100%; padding: 20px; gap: 20px; }
        
        .camera-container { background: black; border-radius: 20px; position: relative; overflow: hidden; border: 4px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        video { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 10; }
        
        .start-btn { position: absolute; z-index: 50; padding: 15px 40px; background: var(--primary); color: white; border: none; border-radius: 40px; font-weight: 800; font-size: 1.2rem; cursor: pointer; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.5); }
        
        .face-status { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; z-index: 20; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 8px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--alert); }
        .dot.active { background: var(--safe); box-shadow: 0 0 10px var(--safe); }

        .info-panel { background: white; border-radius: 20px; padding: 25px; display: flex; flex-direction: column; gap: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .status-big { font-size: 2.5rem; font-weight: 800; color: var(--primary); line-height: 1; }
        .log-box { flex: 1; background: #f1f5f9; border-radius: 12px; padding: 15px; overflow-y: auto; font-size: 0.85rem; color: #475569; }

        /* --- DOCTOR UI --- */
        .doc-header { background: white; padding: 20px 40px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .doc-grid { padding: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1200px; margin: 0 auto; width: 100%; }
        
        .patient-card { background: white; border-radius: 20px; padding: 25px; border: 1px solid #e2e8f0; position: relative; overflow: hidden; transition: 0.3s; }
        .patient-card.alert { border-color: var(--alert); background: #fef2f2; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
        
        .metric-row { display: flex; gap: 20px; margin-top: 20px; }
        .metric { flex: 1; background: #f8fafc; padding: 15px; border-radius: 12px; }
        .metric-val { font-size: 1.5rem; font-weight: 800; color: var(--dark); }
        
        .live-indicator { display: inline-block; width: 8px; height: 8px; background: var(--safe); border-radius: 50%; animation: blink 1s infinite; margin-right: 5px; }
        @keyframes blink { 50% { opacity: 0.4; } }

        /* GESTURE GUIDE */
        .g-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .g-item { background: #f1f5f9; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.8rem; border: 1px solid transparent; }
        .g-item.active { background: #dbeafe; border-color: var(--primary); color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <div id="role-select" class="role-overlay">
        <div class="role-card" onclick="startPatient()">
            <div class="role-icon"><i class="fas fa-user-injured"></i></div>
            <h2>Patient Mode</h2>
            <p>Start Bedside Camera</p>
        </div>
        <div class="role-card" onclick="startDoctor()">
            <div class="role-icon"><i class="fas fa-user-md"></i></div>
            <h2>Doctor Mode</h2>
            <p>Monitor Real-Time Alerts</p>
        </div>
    </div>

    <div id="screen-patient" class="app-screen">
        <div class="patient-grid">
            <div class="camera-container">
                <div class="face-status"><div class="dot" id="face-dot"></div> <span id="face-text">NO FACE DETECTED</span></div>
                <video id="input_video" playsinline muted></video>
                <canvas id="output_canvas"></canvas>
                <button id="cam-btn" class="start-btn" onclick="initCamera()">START CAMERA</button>
            </div>
            
            <div class="info-panel">
                <div>
                    <h3 style="margin:0; color:#94a3b8; font-size:0.8rem; font-weight:700; text-transform:uppercase;">Current Request</h3>
                    <div class="status-big" id="p-status">--</div>
                </div>
                
                <div class="g-list">
                    <div class="g-item" id="g-victory">‚úåÔ∏è Water</div>
                    <div class="g-item" id="g-point">‚òùÔ∏è Meds</div>
                    <div class="g-item" id="g-thumb">üëç Yes</div>
                    <div class="g-item" id="g-palm">‚úã Help</div>
                    <div class="g-item" id="g-fist">‚úä Stop</div>
                </div>

                <div style="flex:1; display:flex; flex-direction:column;">
                    <h3 style="margin:0 0 10px 0; font-size:0.9rem;">Sent Logs</h3>
                    <div class="log-box" id="p-logs"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-doctor" class="app-screen">
        <div class="doc-header">
            <div style="font-size:1.5rem; font-weight:800; color:var(--primary);"><i class="fas fa-heartbeat"></i> VisionCare MD</div>
            <div>Dr. Emily Chen <span style="background:#dcfce7; color:#166534; padding:5px 10px; border-radius:20px; font-size:0.8rem; font-weight:bold; margin-left:10px;">ONLINE</span></div>
        </div>

        <div class="doc-grid">
            <div class="patient-card" id="doc-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div style="width:50px; height:50px; background:#e2e8f0; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#64748b;">AS</div>
                        <div>
                            <h3 style="margin:0;">Alex Smith</h3>
                            <div style="font-size:0.8rem; color:#64748b;">Bed 104 ‚Ä¢ Post-Op</div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold; color:var(--safe);"><span class="live-indicator"></span>Live</div>
                    </div>
                </div>

                <div style="background:#f8fafc; padding:20px; border-radius:12px; text-align:center; border:2px dashed #e2e8f0;" id="alert-box">
                    <div style="font-size:0.8rem; font-weight:bold; color:#94a3b8; margin-bottom:5px;">LATEST ALERT</div>
                    <div style="font-size:2rem; font-weight:800; color:var(--dark);" id="doc-alert">No Active Alerts</div>
                    <div style="font-size:0.8rem; color:#64748b; margin-top:5px;" id="doc-time">Waiting for data...</div>
                </div>

                <div class="metric-row">
                    <div class="metric">
                        <div style="font-size:0.8rem; color:#64748b;">Heart Rate</div>
                        <div class="metric-val" style="color:var(--alert);">72 <span style="font-size:1rem;">bpm</span></div>
                    </div>
                    <div class="metric">
                        <div style="font-size:0.8rem; color:#64748b;">SpO2</div>
                        <div class="metric-val" style="color:var(--primary);">98%</div>
                    </div>
                </div>
            </div>

            <div class="patient-card">
                <h3>Incoming Feed</h3>
                <div id="doc-feed" style="height:300px; overflow-y:auto; margin-top:15px; padding-right:10px;">
                    </div>
            </div>
        </div>
    </div>

<script>
    // --- REAL TIME SYNC ENGINE ---
    // Uses BroadcastChannel API to send data between tabs instantly
    const channel = new BroadcastChannel('visioncare_sync');

    // --- UI HELPERS ---
    const video = document.getElementById('input_video');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    const faceDot = document.getElementById('face-dot');
    const faceText = document.getElementById('face-text');
    const pStatus = document.getElementById('p-status');
    const pLogs = document.getElementById('p-logs');

    // Doctor UI
    const docAlert = document.getElementById('doc-alert');
    const docTime = document.getElementById('doc-time');
    const docCard = document.getElementById('doc-card');
    const docFeed = document.getElementById('doc-feed');

    let faceDetected = false;
    let lastMsg = "";

    // --- 1. NAVIGATION ---
    function startPatient() {
        document.getElementById('role-select').style.display = 'none';
        document.getElementById('screen-patient').classList.add('active');
    }

    function startDoctor() {
        document.getElementById('role-select').style.display = 'none';
        document.getElementById('screen-doctor').classList.add('active');
        
        // Listen for data
        channel.onmessage = (event) => {
            const data = event.data;
            updateDoctorUI(data.msg, data.time);
        };
    }

    // --- 2. CAMERA & AI (PATIENT SIDE) ---
    async function initCamera() {
        document.getElementById('cam-btn').innerText = "LOADING AI...";
        
        // Load Models
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({maxNumHands: 1, minDetectionConfidence: 0.5});
        hands.onResults(onHandResults);

        const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({maxNumFaces: 1, minDetectionConfidence: 0.5});
        faceMesh.onResults(onFaceResults);

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                document.getElementById('cam-btn').style.display = 'none';
                
                // Start Loop
                const camera = new Camera(video, {
                    onFrame: async () => {
                        await faceMesh.send({image: video});
                        if(faceDetected) await hands.send({image: video}); // Optimize: Only check hands if face is there
                    },
                    width: 1280, height: 720
                });
                camera.start();
            };
        } catch(e) {
            alert("Camera Error: " + e.message);
            document.getElementById('cam-btn').innerText = "RETRY";
        }
    }

    // --- 3. FACE DETECTION ---
    function onFaceResults(results) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            faceDetected = true;
            faceText.innerText = "FACE VERIFIED";
            faceText.style.color = "#10b981";
            faceDot.classList.add('active');
            
            // Draw face mesh
            drawConnectors(ctx, results.multiFaceLandmarks[0], FACEMESH_TESSELATION, {color: '#10b98120', lineWidth: 1});
        } else {
            faceDetected = false;
            faceText.innerText = "NO FACE";
            faceText.style.color = "white";
            faceDot.classList.remove('active');
            pStatus.innerText = "--";
        }
    }

    // --- 4. GESTURE RECOGNITION ---
    function onHandResults(results) {
        if(!faceDetected) return;

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#2563eb', lineWidth: 3});
            drawLandmarks(ctx, lm, {color: '#ef4444', lineWidth: 1});

            // Logic
            let fingers = [];
            [8, 12, 16, 20].forEach(t => fingers.push(lm[t].y < lm[t-2].y ? 1 : 0)); // Fingers
            fingers.unshift(lm[4].x < lm[3].x ? 1 : 0); // Thumb

            let msg = "";
            let id = "";
            const fStr = fingers.join("");

            if(fStr === "00000") { msg = "STOP"; id="g-fist"; }
            else if(fStr === "11111") { msg = "HELP"; id="g-palm"; }
            else if(fStr === "01100") { msg = "WATER"; id="g-victory"; }
            else if(fStr === "01000") { msg = "MEDS"; id="g-point"; }
            else if(fStr === "10000") { msg = "YES"; id="g-thumb"; }

            if(msg && msg !== lastMsg) {
                lastMsg = msg;
                handleEvent(msg, id);
            }
        }
    }

    // --- 5. EVENT HANDLER ---
    function handleEvent(msg, id) {
        // Update Patient UI
        pStatus.innerText = msg;
        
        // Highlight Guide
        document.querySelectorAll('.g-item').forEach(el => el.classList.remove('active'));
        if(id) document.getElementById(id).classList.add('active');

        // Log
        const time = new Date().toLocaleTimeString();
        const log = document.createElement('div');
        log.style.marginBottom = "5px";
        log.innerHTML = `<b>${msg}</b> <span style="color:#94a3b8">${time}</span>`;
        pLogs.prepend(log);

        // SEND TO DOCTOR
        channel.postMessage({ msg: msg, time: time });
    }

    // --- 6. DOCTOR RECEIVER ---
    function updateDoctorUI(msg, time) {
        docAlert.innerText = msg;
        docTime.innerText = "Received at " + time;

        // Visual Alert
        docCard.classList.remove('alert');
        void docCard.offsetWidth; // Trigger reflow
        docCard.classList.add('alert');
        setTimeout(() => docCard.classList.remove('alert'), 3000);

        // Add to Feed
        const item = document.createElement('div');
        item.style.padding = "10px";
        item.style.borderBottom = "1px solid #f1f5f9";
        item.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <span style="font-weight:bold; color:var(--dark)">${msg}</span>
                <span style="color:#64748b; font-size:0.8rem">${time}</span>
            </div>
        `;
        docFeed.prepend(item);

        // Play Sound
        // const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3');
        // audio.play().catch(e => console.log("Audio blocked"));
    }

</script>
</body>
</html>
