<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionCare - Smart Ward System</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <style>
        :root { --primary: #6366f1; --dark: #1e293b; --light: #f8fafc; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- SCREEN MANAGEMENT --- */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.5s; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- SCREEN 1: MOBILE AUTH --- */
        .auth-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; outline: none; transition: 0.3s; }
        .input-group input:focus { border-color: var(--primary); }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:hover { background: #4f46e5; }

        /* --- SCREEN 2: FACE REGISTRATION --- */
        .reg-container { position: relative; width: 100%; max-width: 600px; }
        .scan-frame { 
            width: 100%; height: 400px; background: black; border-radius: 20px; position: relative; overflow: hidden; 
            border: 4px solid white; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .scan-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 250px; height: 300px; border: 3px dashed rgba(255,255,255,0.5); border-radius: 150px;
            display: flex; align-items: center; justify-content: center;
        }
        .scan-line {
            width: 100%; height: 4px; background: var(--success); position: absolute; top: 0;
            animation: scan 2s infinite linear; display: none; box-shadow: 0 0 10px var(--success);
        }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        .reg-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* --- SCREEN 3: DASHBOARD --- */
        .dashboard-header { width: 100%; padding: 15px 30px; background: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
        .db-grid { display: grid; grid-template-columns: 2fr 1fr; width: 100%; height: 100%; gap: 20px; padding: 20px; }
        
        .monitor-panel { background: black; border-radius: 16px; position: relative; overflow: hidden; display: flex; }
        .monitor-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .split-line { position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: rgba(255,255,255,0.3); border-left: 2px dashed rgba(0,0,0,0.5); }
        
        .patient-label { position: absolute; top: 20px; color: white; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .p1-lbl { left: 20px; border-left: 4px solid var(--primary); }
        .p2-lbl { right: 20px; border-right: 4px solid var(--success); }
        
        .log-panel { background: white; border-radius: 16px; padding: 20px; display: flex; flex-direction: column; }
        .log-item { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }

        .status-badge { width: 10px; height: 10px; border-radius: 50%; }
        .badge-p1 { background: var(--primary); }
        .badge-p2 { background: var(--success); }

        /* SOS OVERLAY */
        #sos-overlay { position: fixed; inset: 0; background: rgba(239, 68, 68, 0.95); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: white; }
    </style>
</head>
<body>

    <div id="screen-auth" class="screen active">
        <div class="auth-card">
            <h1 style="color:var(--primary); margin-bottom:10px;">VisionCare</h1>
            <p style="color:#64748b; margin-bottom:30px;">Doctor / Staff Login</p>
            
            <div id="step-1">
                <div class="input-group">
                    <label>Mobile Number</label>
                    <input type="tel" id="mobile-input" placeholder="+91 98765 43210">
                </div>
                <button class="btn" onclick="sendOTP()">Get OTP</button>
            </div>

            <div id="step-2" style="display:none;">
                <div class="input-group">
                    <label>Enter OTP</label>
                    <input type="text" id="otp-input" placeholder="1234">
                </div>
                <button class="btn" onclick="verifyOTP()">Verify & Login</button>
                <p style="margin-top:15px; font-size:0.9rem; color:#64748b; cursor:pointer;" onclick="location.reload()">Resend OTP</p>
            </div>
        </div>
    </div>

    <div id="screen-reg" class="screen">
        <h2 style="margin-bottom:10px; color:var(--dark);">Patient Registration</h2>
        <p style="margin-bottom:20px; color:#64748b;" id="reg-instruction">Position <b>BED 1 Patient</b> in frame to register.</p>
        
        <div class="reg-container">
            <div class="scan-frame">
                <video id="reg-video" class="reg-video" autoplay playsinline muted></video>
                <div class="scan-overlay">
                    <div class="scan-line" id="scan-line"></div>
                </div>
            </div>
        </div>
        
        <button class="btn" style="width:200px; margin-top:20px;" id="scan-btn" onclick="scanFace()">Start Scan</button>
        <p id="reg-status" style="margin-top:15px; font-weight:bold; color:var(--primary); height:20px;"></p>
    </div>

    <div id="screen-dash" class="screen">
        <div class="dashboard-header">
            <div style="font-weight:bold; font-size:1.2rem; color:var(--primary);">üè• Ward 104 Monitor</div>
            <button onclick="location.reload()" style="background:none; border:1px solid #e2e8f0; padding:8px 15px; border-radius:8px; cursor:pointer;">Logout</button>
        </div>
        
        <div class="db-grid">
            <div class="monitor-panel">
                <video id="dash-video" class="monitor-feed" autoplay playsinline muted></video>
                <canvas id="output_canvas" style="position:absolute; width:100%; height:100%; transform: scaleX(-1);"></canvas>
                
                <div class="split-line"></div>
                
                <div class="patient-label p1-lbl">
                    <img id="img-p1" style="width:30px; height:30px; border-radius:50%; border:2px solid white;">
                    <div>
                        <div style="font-size:0.7rem; opacity:0.8;">BED 1</div>
                        <div id="name-p1">Registering...</div>
                    </div>
                </div>

                <div class="patient-label p2-lbl">
                    <div style="text-align:right;">
                        <div style="font-size:0.7rem; opacity:0.8;">BED 2</div>
                        <div id="name-p2">Registering...</div>
                    </div>
                    <img id="img-p2" style="width:30px; height:30px; border-radius:50%; border:2px solid white;">
                </div>
            </div>

            <div class="log-panel">
                <h3 style="margin-bottom:20px;">Live Notifications</h3>
                <div style="flex:1; overflow-y:auto;" id="log-container">
                    </div>
            </div>
        </div>
    </div>

    <div id="sos-overlay">
        <h1 style="font-size:4rem;">üö® EMERGENCY</h1>
        <h2 id="sos-msg">Bed 1 Distress Signal</h2>
        <button onclick="dismissSOS()" style="margin-top:30px; padding:15px 40px; border:none; border-radius:30px; font-weight:bold; font-size:1.2rem; cursor:pointer;">ACKNOWLEDGE</button>
    </div>

<script>
    // --- STATE ---
    let currentStep = 0; // 0=P1 Scan, 1=P2 Scan
    let p1Image = "";
    let p2Image = "";
    let isSosActive = false;
    let lastSpoken = "";
    let lastP1 = 0, lastP2 = 0;

    // --- DOM ELEMENTS ---
    const regVideo = document.getElementById('reg-video');
    const dashVideo = document.getElementById('dash-video');
    const scanLine = document.getElementById('scan-line');
    const regStatus = document.getElementById('reg-status');
    const regInstruction = document.getElementById('reg-instruction');
    const scanBtn = document.getElementById('scan-btn');
    const logContainer = document.getElementById('log-container');

    // --- GESTURE MAP ---
    const gestureMap = {
        "0,0,0,0,0": { msg: "Stop" },
        "1,1,1,1,1": { msg: "Hello" },
        "0,1,1,0,0": { msg: "Water" },
        "0,1,0,0,0": { msg: "Medicine" },
        "1,0,0,0,0": { msg: "Yes" },
        "1,1,1,0,0": { msg: "Chest Pain" },
        "0,1,1,1,1": { msg: "Headache" }
    };

    // --- STEP 1: AUTH ---
    function sendOTP() {
        const num = document.getElementById('mobile-input').value;
        if(num.length < 10) return alert("Please enter valid mobile number");
        document.getElementById('step-1').style.display = 'none';
        document.getElementById('step-2').style.display = 'block';
    }

    function verifyOTP() {
        // Simulating Backend Verification
        if(document.getElementById('otp-input').value === "1234") {
            switchScreen('screen-auth', 'screen-reg');
            startRegCamera();
        } else {
            alert("Invalid OTP (Use 1234)");
        }
    }

    // --- STEP 2: REGISTRATION ---
    async function startRegCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            regVideo.srcObject = stream;
        } catch(e) { alert("Camera Error: " + e.message); }
    }

    function scanFace() {
        scanBtn.disabled = true;
        scanLine.style.display = 'block';
        regStatus.innerText = "Scanning Biometrics...";
        
        setTimeout(() => {
            // Capture Snapshot
            const canvas = document.createElement('canvas');
            canvas.width = regVideo.videoWidth;
            canvas.height = regVideo.videoHeight;
            canvas.getContext('2d').drawImage(regVideo, 0, 0);
            const imgData = canvas.toDataURL('image/png');

            if(currentStep === 0) {
                p1Image = imgData;
                regStatus.innerText = "Bed 1 Registered!";
                setTimeout(() => {
                    currentStep = 1;
                    regInstruction.innerHTML = "Position <b>BED 2 Patient</b> in frame.";
                    regStatus.innerText = "";
                    scanLine.style.display = 'none';
                    scanBtn.disabled = false;
                    scanBtn.innerText = "Scan Bed 2";
                }, 1500);
            } else {
                p2Image = imgData;
                regStatus.innerText = "Registration Complete!";
                setTimeout(() => {
                    startDashboard();
                }, 1500);
            }
        }, 2000); // 2s Fake Scan
    }

    // --- STEP 3: DASHBOARD ---
    function startDashboard() {
        switchScreen('screen-reg', 'screen-dash');
        
        // Stop Reg Camera
        let stream = regVideo.srcObject;
        if(stream) stream.getTracks().forEach(track => track.stop());

        // Setup UI
        document.getElementById('img-p1').src = p1Image;
        document.getElementById('name-p1').innerText = "Alex (Active)";
        document.getElementById('img-p2').src = p2Image;
        document.getElementById('name-p2').innerText = "Sarah (Active)";

        // Start AI
        initAI();
    }

    // --- AI MONITORING LOGIC ---
    async function initAI() {
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5 });
        hands.onResults(onResults);

        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        dashVideo.srcObject = stream;
        
        const camera = new Camera(dashVideo, {
            onFrame: async () => { await hands.send({image: dashVideo}); },
            width: 1280, height: 720
        });
        camera.start();
    }

    // Helper: Camera Class Shim (Simpler than importing huge lib)
    class Camera {
        constructor(video, options) {
            this.video = video;
            this.onFrame = options.onFrame;
        }
        async start() {
            const loop = async () => {
                if(this.video.readyState >= 2) await this.onFrame();
                requestAnimationFrame(loop);
            };
            loop();
        }
    }

    function onResults(results) {
        const canvas = document.getElementById('output_canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = dashVideo.videoWidth;
        canvas.height = dashVideo.videoHeight;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        // Draw Split Line
        ctx.beginPath();
        ctx.moveTo(canvas.width/2, 0);
        ctx.lineTo(canvas.width/2, canvas.height);
        ctx.strokeStyle = "rgba(255,255,255,0.5)";
        ctx.lineWidth = 2;
        ctx.setLineDash([10, 10]);
        ctx.stroke();

        if (results.multiHandLandmarks) {
            for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                const lm = results.multiHandLandmarks[i];
                drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#6366f1', lineWidth: 2});
                drawLandmarks(ctx, lm, {color: '#ef4444', lineWidth: 1});

                // IDENTIFY PATIENT (Left < 0.5 < Right)
                // Note: Video is mirrored via CSS scaleX(-1), but coordinates are typically 0->1 left->right relative to source.
                // We check X to assign ID.
                const x = lm[0].x;
                const pid = x < 0.5 ? 1 : 2; 

                // DETECT
                detectGesture(lm, pid);
            }
        }
    }

    function detectGesture(lm, pid) {
        let fingers = [];
        // Simple logic: Is finger tip above pip joint?
        [8, 12, 16, 20].forEach(t => fingers.push(lm[t].y < lm[t-2].y ? 1 : 0));
        // Thumb (X check)
        fingers.unshift(lm[4].x < lm[3].x ? 1 : 0);

        let key = fingers.join(",");
        let msg = "Scanning...";
        if(gestureMap[key]) msg = gestureMap[key].msg;
        else if(Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y) < 0.05) msg = "Okay"; // OK Sign

        if(msg !== "Scanning...") handleAlert(pid, msg);
    }

    function handleAlert(pid, msg) {
        const now = Date.now();
        // Cooldown 2s
        if(pid === 1 && now - lastP1 < 2000) return;
        if(pid === 2 && now - lastP2 < 2000) return;
        
        if(pid === 1) lastP1 = now; else lastP2 = now;

        // Speak
        if(!isSosActive) {
            const speech = new SpeechSynthesisUtterance(`Bed ${pid} needs ${msg}`);
            window.speechSynthesis.speak(speech);
        }

        // Log
        addLog(pid, msg);

        // Emergency?
        if(msg.includes("Pain") || msg.includes("Stop")) triggerSOS(pid, msg);
    }

    function addLog(pid, msg) {
        const div = document.createElement('div');
        div.className = "log-item";
        div.innerHTML = `
            <div class="status-badge ${pid===1?'badge-p1':'badge-p2'}"></div>
            <div><b>Bed ${pid}</b>: ${msg}</div>
            <div style="margin-left:auto; color:#94a3b8; font-size:0.8rem;">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
        `;
        logContainer.prepend(div);
    }

    function triggerSOS(pid, msg) {
        isSosActive = true;
        document.getElementById('sos-msg').innerText = `BED ${pid}: ${msg}`;
        document.getElementById('sos-overlay').style.display = 'flex';
    }

    function dismissSOS() {
        isSosActive = false;
        document.getElementById('sos-overlay').style.display = 'none';
        window.speechSynthesis.cancel();
    }

    // --- UTILS ---
    function switchScreen(hide, show) {
        document.getElementById(hide).classList.remove('active');
        setTimeout(() => document.getElementById(show).classList.add('active'), 100);
    }
</script>
</body>
</html>
