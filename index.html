<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionCare - Secure Ward Monitor</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <style>
        :root { --primary: #6366f1; --dark: #1e293b; --light: #f8fafc; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* SCREENS */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }
        .center-box { display: flex; align-items: center; justify-content: center; height: 100%; }

        /* CARDS & INPUTS */
        .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 400px; text-align: center; }
        .input-group { text-align: left; margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 700; color: #64748b; margin-bottom: 5px; }
        .input-field { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn:hover { background: #4f46e5; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* DASHBOARD LAYOUT */
        .dashboard-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; padding: 20px; flex: 1; overflow: hidden; }
        .panel { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        
        /* CAMERA FEED */
        .cam-container { position: relative; background: black; border-radius: 12px; overflow: hidden; flex: 1; min-height: 400px; border: 4px solid white; display: flex; justify-content: center; align-items: center; }
        video { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 10; }
        
        .face-status { position: absolute; top: 10px; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; color: white; z-index: 20; display: flex; align-items: center; gap: 5px; }
        .status-left { left: 10px; }
        .status-right { right: 10px; }
        .locked { background: rgba(239, 68, 68, 0.9); }
        .verified { background: rgba(16, 185, 129, 0.9); }

        /* PATIENT HISTORY */
        .history-card { background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #ccc; font-size: 0.9rem; text-align: left; }
        .history-card.active { border-color: var(--primary); background: #e0e7ff; }
        
        /* LOGS */
        .log-box { height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 5px; }
        .log-entry { padding: 8px; border-bottom: 1px solid #eee; font-size: 0.85rem; display: flex; justify-content: space-between; }

        /* LOADING */
        .scan-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 50; display: none; align-items: center; justify-content: center; color: white; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 1000px) { .dashboard-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active center-box">
        <div class="card">
            <h1 style="color:var(--primary); margin:0;">VisionCare Admin</h1>
            <p style="color:#64748b; margin-bottom:30px;">Ward Monitoring System</p>
            <div class="input-group">
                <label>Doctor Mobile</label>
                <input type="tel" class="input-field" placeholder="+91..." value="9876543210">
            </div>
            <button class="btn" onclick="sendOTP()">Send OTP</button>
        </div>
    </div>

    <div id="screen-reg" class="screen center-box">
        <div class="card" style="width: 800px; display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
            <div>
                <h2 style="margin-top:0;">New Patient Entry</h2>
                
                <div class="input-group">
                    <label>Select Bed</label>
                    <select id="reg-bed" class="input-field">
                        <option value="1">Bed 1 (Window Side)</option>
                        <option value="2">Bed 2 (Door Side)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Ward Number</label>
                    <input type="text" id="reg-ward" class="input-field" value="104-A">
                </div>
                <div class="input-group">
                    <label>Patient Name</label>
                    <input type="text" id="reg-name" class="input-field" placeholder="John Doe">
                </div>
                <div class="input-group">
                    <label>Medical History / Condition</label>
                    <textarea id="reg-history" class="input-field" rows="3" placeholder="Diabetes, Post-Surgery..."></textarea>
                </div>
                <button class="btn btn-outline" onclick="goToDash()">Skip / Go to Monitor</button>
            </div>
            
            <div style="display:flex; flex-direction:column; justify-content:center;">
                <div class="cam-container" style="height:300px; min-height:0; border:2px solid var(--primary);">
                    <video id="reg-video" autoplay playsinline muted></video>
                    <div class="scan-overlay" id="reg-overlay">
                        <div class="spinner"></div>
                        <div>Scanning Biometrics...</div>
                    </div>
                </div>
                <p style="font-size:0.8rem; color:#64748b; margin-top:10px;">* Ensure patient face is centered</p>
                <button class="btn" onclick="registerPatient()">CAPTURE FACE ID & SAVE</button>
            </div>
        </div>
    </div>

    <div id="screen-dash" class="screen">
        <div style="padding:15px 30px; background:white; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:800; font-size:1.2rem; color:var(--primary);"><i class="fas fa-eye"></i> VisionCare Monitor</div>
            <div style="font-size:0.9rem;">Dr. Login <button onclick="location.reload()" style="margin-left:10px; color:red; border:none; background:none; cursor:pointer;">Logout</button></div>
        </div>

        <div class="dashboard-layout">
            
            <div class="panel" style="padding:0; overflow:hidden;">
                <div class="cam-container">
                    <button id="start-btn" class="btn" style="position:absolute; width:auto; z-index:50;" onclick="startMonitoring()">START MONITORING SYSTEM</button>
                    <video id="dash-video" playsinline muted></video>
                    <canvas id="dash-canvas"></canvas>
                    
                    <div class="face-status status-left locked" id="status-p1">
                        <i class="fas fa-lock"></i> <span id="txt-p1">NO PATIENT</span>
                    </div>
                    <div class="face-status status-right locked" id="status-p2">
                        <i class="fas fa-lock"></i> <span id="txt-p2">NO PATIENT</span>
                    </div>
                    
                    <div style="position:absolute; left:50%; top:0; bottom:0; border-left:2px dashed rgba(255,255,255,0.4); z-index:15;"></div>
                </div>
                
                <div style="padding:15px; background:white; display:flex; justify-content:space-between;">
                    <div><strong>Live Activity:</strong> <span id="live-action">--</span></div>
                    <button id="voice-btn" onclick="toggleVoice()" style="border:none; background:#e0e7ff; color:var(--primary); padding:5px 10px; border-radius:5px; font-weight:bold;">ðŸ”Š Voice ON</button>
                </div>
            </div>

            <div class="panel">
                <h3 style="margin-top:0;">Patient Records</h3>
                
                <div id="p1-card" class="history-card">
                    <strong>BED 1:</strong> Not Registered<br>
                    <small>History: --</small>
                </div>
                
                <div id="p2-card" class="history-card">
                    <strong>BED 2:</strong> Not Registered<br>
                    <small>History: --</small>
                </div>

                <h3>Real-Time Logs</h3>
                <div class="log-box" id="log-container"></div>
            </div>
        </div>
    </div>

<script>
    // --- STATE ---
    let patients = {
        1: { registered: false, name: "", history: "", faceDesc: null },
        2: { registered: false, name: "", history: "", faceDesc: null }
    };
    
    let voiceMuted = false;
    let lastSpoken = "";
    let lastLogTime = 0;

    // --- DOM ELEMENTS ---
    const regVideo = document.getElementById('reg-video');
    const dashVideo = document.getElementById('dash-video');
    const canvas = document.getElementById('dash-canvas');
    const ctx = canvas.getContext('2d');
    
    // --- AUTH FLOW ---
    function sendOTP() {
        // Simulation
        const phone = document.querySelector('input[type="tel"]').value;
        if(phone.length < 5) return alert("Enter valid mobile");
        
        let otp = Math.floor(1000 + Math.random() * 9000);
        let userOtp = prompt(`[SMS SIMULATION] Your OTP is: ${otp}`, "");
        
        if(userOtp == otp) {
            document.getElementById('screen-login').style.display = 'none';
            document.getElementById('screen-reg').style.display = 'flex';
            startRegCamera();
        } else {
            alert("Wrong OTP");
        }
    }

    function goToDash() {
        document.getElementById('screen-reg').style.display = 'none';
        document.getElementById('screen-dash').style.display = 'flex';
        // Stop reg camera
        if(regVideo.srcObject) regVideo.srcObject.getTracks().forEach(t=>t.stop());
    }

    // --- REGISTRATION LOGIC ---
    let tempFaceData = null; // Store landmarks temporarily during registration
    
    async function startRegCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            regVideo.srcObject = stream;
            
            // Init AI for Registration
            const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
            faceMesh.setOptions({maxNumFaces: 1, minDetectionConfidence: 0.5});
            faceMesh.onResults((results) => {
                if(results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    tempFaceData = generateFaceDescriptor(results.multiFaceLandmarks[0]);
                }
            });
            
            const camera = new Camera(regVideo, {
                onFrame: async () => { await faceMesh.send({image: regVideo}); },
                width: 640, height: 480
            });
            camera.start();

        } catch(e) { alert("Camera Error"); }
    }

    function generateFaceDescriptor(landmarks) {
        // Simplified biometric: Distance between eyes, nose width, etc.
        // This creates a simple "vector" to compare later.
        const leftEye = landmarks[33];
        const rightEye = landmarks[263];
        const nose = landmarks[1];
        const chin = landmarks[152];

        // Ratios (invariant to distance/scale)
        const eyeDist = Math.hypot(leftEye.x - rightEye.x, leftEye.y - rightEye.y);
        const faceHeight = Math.hypot(nose.x - chin.x, nose.y - chin.y);
        
        // This is a VERY simple descriptor. Real systems use 128d vectors.
        return { ratio: eyeDist / faceHeight, raw: landmarks };
    }

    function registerPatient() {
        if(!tempFaceData) return alert("No face detected! Please look at camera.");
        
        const bed = document.getElementById('reg-bed').value;
        const name = document.getElementById('reg-name').value || "Unknown Patient";
        const history = document.getElementById('reg-history').value || "None";
        
        document.getElementById('reg-overlay').style.display = 'flex';
        
        setTimeout(() => {
            // Save Data
            patients[bed] = {
                registered: true,
                name: name,
                history: history,
                faceDesc: tempFaceData // Save the biometric data
            };

            // Update UI
            updateHistoryUI();
            
            document.getElementById('reg-overlay').style.display = 'none';
            alert(`Patient ${name} registered to Bed ${bed} successfully!`);
            
            // Reset fields
            document.getElementById('reg-name').value = "";
            document.getElementById('reg-history').value = "";
        }, 1500);
    }

    function updateHistoryUI() {
        if(patients[1].registered) {
            document.getElementById('p1-card').innerHTML = `<strong>BED 1:</strong> ${patients[1].name}<br><small>History: ${patients[1].history}</small>`;
            document.getElementById('p1-card').classList.add('active');
        }
        if(patients[2].registered) {
            document.getElementById('p2-card').innerHTML = `<strong>BED 2:</strong> ${patients[2].name}<br><small>History: ${patients[2].history}</small>`;
            document.getElementById('p2-card').classList.add('active');
        }
    }

    // --- MONITORING LOGIC ---
    async function startMonitoring() {
        document.getElementById('start-btn').style.display = 'none';
        
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({maxNumHands: 2, minDetectionConfidence: 0.5});
        hands.onResults(onHandResults);

        const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({maxNumFaces: 2, minDetectionConfidence: 0.5});
        faceMesh.onResults(onFaceResults);

        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        dashVideo.srcObject = stream;
        
        // Custom Loop
        const process = async () => {
            if(!dashVideo.paused && !dashVideo.ended) {
                canvas.width = dashVideo.videoWidth;
                canvas.height = dashVideo.videoHeight;
                await faceMesh.send({image: dashVideo});
                await hands.send({image: dashVideo}); // Hands depend on Face logic
            }
            requestAnimationFrame(process);
        };
        dashVideo.onloadedmetadata = () => { dashVideo.play(); process(); };
    }

    // --- BIO-LOCK LOGIC ---
    let activeUsers = { 1: false, 2: false }; // Is the correct patient in the bed?

    function onFaceResults(results) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        // Reset Status
        activeUsers[1] = false;
        activeUsers[2] = false;
        updateStatusUI(1, "locked", "SEARCHING");
        updateStatusUI(2, "locked", "SEARCHING");

        if (results.multiFaceLandmarks) {
            for (const landmarks of results.multiFaceLandmarks) {
                // 1. Identify Bed (Left/Right)
                const x = landmarks[1].x; // Nose x
                const bedID = x < 0.5 ? 1 : 2;

                // 2. Check Identity
                const liveDesc = generateFaceDescriptor(landmarks);
                const storedData = patients[bedID];

                let isMatch = false;
                if(storedData.registered) {
                    // Simple Diff Check
                    const diff = Math.abs(liveDesc.ratio - storedData.faceDesc.ratio);
                    if(diff < 0.05) isMatch = true; // Threshold
                }

                // 3. Update Status
                if(isMatch) {
                    activeUsers[bedID] = true;
                    updateStatusUI(bedID, "verified", storedData.name.split(" ")[0]);
                    // Draw Green Mesh
                    drawConnectors(ctx, landmarks, FACEMESH_TESSELATION, {color: '#10b98120', lineWidth: 1});
                } else {
                    updateStatusUI(bedID, "locked", "UNAUTHORIZED");
                    // Draw Red Mesh
                    drawConnectors(ctx, landmarks, FACEMESH_TESSELATION, {color: '#ef444420', lineWidth: 1});
                }
            }
        }
    }

    function updateStatusUI(bed, state, text) {
        const el = document.getElementById(`status-p${bed}`);
        const txt = document.getElementById(`txt-p${bed}`);
        el.className = `face-status ${bed===1?'status-left':'status-right'} ${state}`;
        
        let icon = state === "verified" ? "fa-user-check" : "fa-user-lock";
        txt.innerHTML = text;
        el.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
    }

    // --- GESTURE LOGIC ---
    const gestureMap = {
        "0,0,0,0,0": "Stop",
        "1,1,1,1,1": "Hello",
        "0,1,1,0,0": "Water",
        "0,1,0,0,0": "Medicine",
        "1,0,0,0,0": "Yes"
    };

    function onHandResults(results) {
        if (results.multiHandLandmarks) {
            for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                const lm = results.multiHandLandmarks[i];
                
                // 1. Check Spatial Location (Bed 1 or 2)
                const x = lm[0].x;
                const bedID = x < 0.5 ? 1 : 2;

                // 2. BIO-LOCK CHECK: Is the authorized face present?
                if(activeUsers[bedID] === true) {
                    // Allowed
                    drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#6366f1', lineWidth: 3});
                    detectGesture(lm, bedID);
                } else {
                    // Blocked (Grey out hand)
                    drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#94a3b8', lineWidth: 1});
                }
            }
        }
    }

    function detectGesture(lm, bedID) {
        let fingers = [];
        [8, 12, 16, 20].forEach(t => fingers.push(lm[t].y < lm[t-2].y ? 1 : 0));
        fingers.unshift(lm[4].x < lm[3].x ? 1 : 0);
        
        let msg = gestureMap[fingers.join(",")] || "";
        
        if(msg) {
            document.getElementById('live-action').innerText = `Bed ${bedID}: ${msg}`;
            handleLog(bedID, msg);
        }
    }

    function handleLog(bed, msg) {
        if(msg !== lastSpoken && Date.now() - lastLogTime > 2000) {
            lastSpoken = msg;
            lastLogTime = Date.now();
            
            // Voice
            if(!voiceMuted) {
                const name = patients[bed].name || `Patient ${bed}`;
                window.speechSynthesis.speak(new SpeechSynthesisUtterance(`${name} says ${msg}`));
            }

            // Log UI
            const div = document.createElement('div');
            div.className = "log-entry";
            div.innerHTML = `<span><b>Bed ${bed}:</b> ${msg}</span> <span style="color:#aaa">${new Date().toLocaleTimeString()}</span>`;
            document.getElementById('log-container').prepend(div);
        }
    }

    function toggleVoice() {
        voiceMuted = !voiceMuted;
        document.getElementById('voice-btn').innerText = voiceMuted ? "ðŸ”‡ Voice OFF" : "ðŸ”Š Voice ON";
    }

</script>
</body>
</html>
